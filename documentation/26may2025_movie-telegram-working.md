
/Users/philip.galebach/coding-projects/windmill/windmill-test/
‚îú‚îÄ‚îÄ u/philipgalebach/
‚îÇ   ‚îú‚îÄ‚îÄ telegram_bot_handler.py          ‚úÖ MAIN WEBHOOK (Working)
‚îÇ   ‚îú‚îÄ‚îÄ telegram_bot_handler.script.yaml ‚úÖ 
‚îÇ   ‚îú‚îÄ‚îÄ telegram_bot_handler.script.lock ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ movie_mood_generator.py          ‚úÖ CORE AI FUNCTION (Working)
‚îÇ   ‚îú‚îÄ‚îÄ movie_mood_generator.script.yaml ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ movie_mood_generator.script.lock ‚úÖ
‚îú‚îÄ‚îÄ documentation/
‚îÇ   ‚îî‚îÄ‚îÄ 26may2025_movie-telegram-working.md ‚úÖ Working system docs
‚îú‚îÄ‚îÄ requirements.txt                     ‚úÖ Dependencies
‚îú‚îÄ‚îÄ wmill.yaml                          ‚úÖ Windmill config
‚îú‚îÄ‚îÄ .env.template                       ‚úÖ Local dev template
‚îú‚îÄ‚îÄ .gitignore                          ‚úÖ Git ignore
‚îú‚îÄ‚îÄ README.md                           ‚úÖ Documentation
‚îî‚îÄ‚îÄ thinner_openrouter.resource.template.yaml ‚úÖ API key template



# üé¨ Telegram Movie Mood Generator Bot
## Complete System Documentation

### üìã Overview

The Telegram Movie Mood Generator is a complete chatbot system built on Windmill that generates AI-powered mood words for movies. Users can message the bot with any movie title, and it responds with descriptive mood words generated using Google's Gemini AI through the OpenRouter API.

---

## üèóÔ∏è System Architecture

```
Telegram User ‚Üí Telegram API ‚Üí Windmill Webhook ‚Üí Movie Mood Generator ‚Üí OpenRouter API ‚Üí Gemini AI
     ‚Üì              ‚Üì              ‚Üì                    ‚Üì                    ‚Üì           ‚Üì
  Sends Movie    Webhook       Processes           Calls Core           Makes API    Generates
    Title        Triggers      Message &           Function             Request      Mood Words
                 Script        Routing                                               
                    ‚Üì              ‚Üì                    ‚Üì                    ‚Üì           ‚Üì
                Response       Formats              Returns              Returns       ‚Üì
                Sent Back      Response             Mood Data            AI Response   ‚Üì
                    ‚Üê              ‚Üê                    ‚Üê                    ‚Üê           ‚Üê
```

---

## üîß Core Components

### 1. **Telegram Bot Handler** (`u/philipgalebach/telegram_bot_handler`)

**Purpose**: Main webhook endpoint that receives and processes all Telegram messages

**Function Signature**:
```python
def main(message: dict = None, update_id: int = None, **kwargs) -> dict
```

**Key Features**:
- ‚úÖ Handles Telegram webhook format directly (message/update_id parameters)
- ‚úÖ Processes commands (`/start`, `/help`)
- ‚úÖ Routes movie titles to mood generation
- ‚úÖ Manages error handling and user feedback
- ‚úÖ Sends formatted responses back to users

**Webhook URL**: 
```
https://app.windmill.dev/api/w/philip-galebach/jobs/run/p/u/philipgalebach/telegram_bot_handler?token=vXu92vBgaf0omsJF2x1imCOwRMuKzPiv
```

### 2. **Movie Mood Generator** (`u/philipgalebach/movie_mood_generator`)

**Purpose**: Core AI function that generates mood words for movies

**Function Signature**:
```python
def generate_movie_moods(movie_title: str) -> dict
```

**Process**:
1. Retrieves OpenRouter API key from Windmill resources
2. Constructs AI prompt for mood generation
3. Calls Google Gemini 2.0 Flash Lite via OpenRouter
4. Returns structured response with mood words

---

## üìä Data Flow

### User Sends Movie Title

1. **User Input**: User messages bot with "Inception"
2. **Telegram Webhook**: Telegram POSTs to Windmill:
   ```json
   {
     "message": {
       "chat": {"id": 464221960},
       "text": "Inception"
     },
     "update_id": 123
   }
   ```
3. **Windmill Processing**: Script receives `message` and `update_id` parameters
4. **Movie Analysis**: Calls `generate_movie_moods("Inception")`
5. **AI Generation**: OpenRouter API call with prompt:
   ```
   Generate 3-5 mood words that describe the movie 'Inception'. 
   Return only the mood words separated by commas.
   ```
6. **AI Response**: `"Dark, Complex, Mind-bending, Layered, Intense"`
7. **User Response**: Bot sends formatted message:
   ```
   üé¨ *Inception*
   
   üé≠ **Mood Words:** Dark, Complex, Mind-bending, Layered, Intense
   
   ‚ú® _Generated by google/gemini-2.0-flash-lite-001_
   ```

### User Sends Command

1. **User Input**: User messages bot with "/start"
2. **Command Processing**: Script detects command format
3. **Welcome Response**: Sends instruction message with examples

---

## ‚öôÔ∏è Configuration

### üîë Resources & Credentials

| Resource | Path | Contains |
|----------|------|----------|
| **OpenRouter API** | `u/philipgalebach/thinner_openrouter` | OpenRouter API key for AI access |
| **Telegram Bot** | `u/philipgalebach/windmill_telegram_test2_bot` | Bot token: `[REDACTED_BOT_TOKEN]` |

### üåê External Services

| Service | Model/Version | Purpose |
|---------|---------------|---------|
| **OpenRouter** | `google/gemini-2.0-flash-lite-001` | AI mood word generation |
| **Telegram Bot API** | Latest | Message handling & responses |

### üîó Webhook Configuration

- **Active Webhook**: Set via Telegram Bot API
- **Endpoint**: Points to `telegram_bot_handler` script
- **Auth Token**: `vXu92vBgaf0omsJF2x1imCOwRMuKzPiv`
- **Content-Type**: `application/json`

---

## üí¨ Bot Interactions

### Commands

| Command | Response | Purpose |
|---------|----------|---------|
| `/start` | Welcome message with instructions | Bot introduction |
| `/help` | Same as `/start` | Help information |
| Unknown command | "Unknown command" message | Error handling |

### Movie Requests

**Input Format**: Any text (not starting with `/`)
**Examples**:
- "Inception"
- "The Dark Knight"
- "Pulp Fiction"
- "Star Wars"

**Response Format**:
```
üé¨ *[Movie Title]*

üé≠ **Mood Words:** [AI-generated mood words]

‚ú® _Generated by [AI model]_
```

### Error Handling

- **No message**: "Please send me a movie title!"
- **API errors**: Detailed error message with retry instructions
- **System errors**: Generic error message with support info

---

## üîß Technical Implementation

### Key Functions

#### `main()` - Webhook Handler
```python
def main(message: dict = None, update_id: int = None, **kwargs) -> dict:
    # Processes Telegram webhooks
    # Routes to appropriate handlers
    # Returns formatted responses
```

#### `generate_movie_moods()` - AI Integration
```python
def generate_movie_moods(movie_title: str) -> dict:
    # Calls OpenRouter API
    # Returns structured mood data
```

#### `send_telegram_message()` - Response Handler
```python
def send_telegram_message(chat_id: int, text: str, parse_mode: str = None) -> dict:
    # Sends messages back to users
    # Handles formatting and errors
```

### Dependencies

```
anyio==4.9.0
certifi==2025.4.26
charset-normalizer==3.4.2
h11==0.16.0
httpcore==1.0.9
httpx==0.28.1
idna==3.10
python-dotenv==1.1.0
requests==2.32.3
sniffio==1.3.1
typing-extensions==4.13.2
urllib3==2.4.0
wmill==1.492.1
```

---

## üß™ Testing

### Manual Testing Commands

```bash
# Test movie request
curl -X POST "https://app.windmill.dev/api/w/philip-galebach/jobs/run/p/u/philipgalebach/telegram_bot_handler?token=vXu92vBgaf0omsJF2x1imCOwRMuKzPiv" \
  -H "Content-Type: application/json" \
  -d '{"message": {"chat": {"id": 464221960}, "text": "Inception"}, "update_id": 123}'

# Test start command
curl -X POST "https://app.windmill.dev/api/w/philip-galebach/jobs/run/p/u/philipgalebach/telegram_bot_handler?token=vXu92vBgaf0omsJF2x1imCOwRMuKzPiv" \
  -H "Content-Type: application/json" \
  -d '{"message": {"chat": {"id": 464221960}, "text": "/start"}, "update_id": 124}'
```

### Live Testing
1. Find bot on Telegram: `@your_bot_username`
2. Send `/start` - Should receive welcome message
3. Send movie titles - Should receive mood words
4. Test error cases with invalid inputs

---

## üöÄ Deployment Status

### ‚úÖ Currently Working
- [x] Webhook endpoint receiving Telegram updates
- [x] Command processing (`/start`, `/help`)
- [x] Movie mood generation via OpenRouter
- [x] Formatted response delivery
- [x] Error handling and user feedback
- [x] Resource management (API keys, tokens)

### üìä Performance
- **Response Time**: ~50ms Windmill overhead + AI generation time
- **Scalability**: Handles concurrent requests via Windmill workers
- **Reliability**: Built-in error handling and retry logic

---

## üîç Monitoring & Logs

### Available in Windmill Dashboard:
- **Job Execution Logs**: Full request/response traces
- **Error Tracking**: Detailed error messages and stack traces
- **Performance Metrics**: Execution times and resource usage
- **Webhook Activity**: All incoming Telegram updates

### Key Log Messages:
```
Received Telegram webhook: {...}
Processing message: 'Inception' from chat_id: 464221960
Generating moods for movie: Inception
[AI Response or Error Details]
```

---

## üéØ Usage Instructions

1. **Start Conversation**: Send `/start` to the bot
2. **Get Movie Moods**: Send any movie title as a regular message
3. **Get Help**: Send `/help` for instructions
4. **Continue**: Send more movie titles for additional mood analyses

The bot provides instant, AI-powered mood word generation for any movie, making it perfect for movie recommendations, mood matching, or creative writing inspiration!
